#include <string.h>
#include "gfmul_fft.h"
#include "parameters.h"
#include "radix16.h"
#include "reduce.h"
#include "CRT_fft.h"

#define N_FAFFT 32768
#define N_FAFFT_32 1024

#define LOW_LEN 81 
#define SPARSE_HW 501

const uint32_t p_inv[LOW_LEN] = {
    0x946e1d09, 0xa96ad483, 0xe3067976, 0x188428c3, 0xbe44b89b, 0xd94c36fa, 0x64fde8cd, 0x06c2edd1,
    0x03f2214a, 0xb99a1ccf, 0x501db63c, 0xcbc29153, 0xe59a87ea, 0xc20fab2e, 0x6a5f1263, 0x644adb71,
    0xacfe3aed, 0x7ea8b8fa, 0xc910187d, 0x56688751, 0x616b724f, 0x63fff975, 0x6f36cee9, 0x681afeb2,
    0x63673a09, 0x2aeab0dc, 0x5daa0ac2, 0x055f4b33, 0xd581c2af, 0xce7cab57, 0x3b427bf7, 0x2606d27f,
    0x5c7733f7, 0x53ebb36d, 0xb38eb677, 0x47840fe2, 0xc9d1186c, 0x88481c32, 0x07ebc33b, 0x9316380c,
    0x3c1185a4, 0xff447307, 0x4bbd9b6a, 0x859a039f, 0xfe461341, 0x415a57ed, 0xdd5e814d, 0x129477a0,
    0x268a81f1, 0x0ca77a62, 0x153f6960, 0x86c32a4d, 0x3def7418, 0x17c4a4d1, 0xe366c874, 0x93cfea0b,
    0x57b16e9a, 0x0afc1068, 0xccf4208d, 0x8ff50caf, 0x065d6f2f, 0x9f97ba45, 0x27b420f9, 0x2bd3c006,
    0xac0e1cda, 0x86494168, 0xb7dfc818, 0x61bbec38, 0x128d7cb6, 0xf108751f, 0x512a92f6, 0xb59b6bfb,
    0x62bd921d, 0x54712067, 0x45e3b4eb, 0x313d9fa7, 0x2ab8de2b, 0x5eec9010, 0xbded9976, 0x38f712bf,
    0xcef335b7};

const uint32_t p_index_div32_sorted[SPARSE_HW] = {
    0, 3, 4, 9, 18, 24, 27, 33, 35, 42, 43, 48, 
    50, 57, 58, 64, 65, 67, 72, 73, 75, 80, 82, 88, 
    90, 97, 105, 112, 120, 129, 131, 139, 144, 146, 147, 154, 
    161, 162, 163, 169, 176, 177, 178, 184, 192, 193, 195, 208, 
    210, 225, 240, 258, 264, 282, 288, 290, 298, 312, 320, 322, 
    328, 330, 352, 360, 384, 386, 394, 402, 416, 418, 424, 432, 
    448, 450, 480, 513, 528, 537, 545, 552, 553, 560, 568, 577, 
    585, 592, 600, 641, 649, 656, 657, 664, 672, 673, 688, 705, 
    720, 768, 792, 800, 808, 832, 840, 896, 904, 912, 928, 960, 
    1024, 1, 16, 19, 34, 35, 49, 50, 64, 65, 67, 80, 
    82, 97, 112, 131, 146, 161, 176, 256, 274, 290, 304, 320, 
    322, 352, 386, 416, 529, 544, 545, 560, 577, 592, 641, 656, 
    784, 800, 832, 896, 2, 8, 11, 32, 34, 41, 42, 64, 
    66, 72, 74, 96, 104, 128, 130, 131, 138, 160, 161, 162, 
    168, 192, 194, 224, 266, 296, 386, 416, 512, 521, 544, 552, 
    576, 584, 640, 641, 648, 672, 704, 776, 896, 0, 3, 33, 
    34, 64, 66, 96, 130, 160, 258, 288, 513, 544, 576, 640, 
    768, 1, 3, 10, 11, 16, 18, 25, 26, 65, 73, 80, 
    88, 129, 130, 131, 137, 144, 145, 146, 152, 193, 208, 256, 
    258, 266, 280, 320, 328, 384, 386, 392, 400, 448, 513, 520, 
    521, 528, 536, 640, 641, 656, 768, 776, 896, 2, 3, 17, 
    18, 65, 80, 129, 144, 258, 272, 320, 384, 512, 513, 528, 
    768, 0, 2, 9, 10, 64, 72, 128, 129, 130, 136, 192, 
    264, 384, 512, 520, 640, 1, 2, 64, 128, 256, 512, 0, 
    1, 3, 8, 9, 11, 16, 18, 24, 26, 33, 41, 48, 
    56, 128, 129, 131, 144, 146, 161, 176, 256, 258, 264, 266, 
    288, 296, 384, 386, 416, 513, 521, 528, 536, 641, 656, 768, 
    776, 896, 0, 1, 3, 16, 18, 33, 48, 256, 258, 288, 
    513, 528, 768, 0, 2, 8, 10, 32, 40, 128, 130, 160, 
    512, 520, 640, 0, 2, 32, 512, 1, 9, 16, 24, 129, 
    144, 256, 264, 384, 1, 16, 256, 0, 8, 128, 0, 1, 
    3, 11, 16, 18, 19, 26, 33, 34, 35, 41, 48, 49, 
    50, 56, 64, 65, 67, 80, 82, 97, 112, 256, 258, 266, 
    274, 288, 290, 296, 304, 320, 322, 352, 513, 521, 528, 529, 
    536, 544, 545, 560, 577, 592, 768, 776, 784, 800, 832, 3, 
    18, 33, 48, 258, 288, 513, 528, 768, 0, 2, 3, 10, 
    32, 33, 34, 40, 64, 66, 96, 258, 288, 512, 513, 520, 
    544, 576, 768, 2, 32, 512, 1, 2, 3, 9, 16, 17, 
    18, 24, 65, 80, 256, 258, 264, 272, 320, 512, 513, 528, 
    768, 1, 16, 256, 0, 1, 2, 8, 64, 256, 512, 0, 
    0, 1, 3, 16, 18, 33, 48, 256, 258, 288, 513, 528, 
    768, 0, 2, 32, 512, 1, 16, 256, 0
};

const uint32_t p_index_mod32_cnt[32] = {109, 39, 41, 16, 44, 16, 16, 6, 39, 13, 12, 4, 9, 3, 3, 1, 48, 9, 19, 3, 19, 3, 7, 1, 13, 0, 4, 0, 3, 0, 1, 0};

static void poly_xor(uint32_t *res, uint32_t *A, uint32_t *B, uint32_t len){
	for(uint32_t i=0; i<len; ++i){
		res[i] = A[i] ^ B[i];
	}
}

void CRT_fft_HQC1(uint32_t *res, const uint32_t *A, const uint32_t *B){
    uint32_t A_FAFFT[N_FAFFT_32] = {0}, B_FAFFT[N_FAFFT_32] = {0};
    uint32_t rx[LOW_LEN << 1];
    uint32_t tmp[LOW_LEN];
    uint32_t t[LOW_LEN << 1];
    uint32_t r[2 * VEC_N_SIZE_32] = {0};
    memcpy(A_FAFFT, A, VEC_N_SIZE_32 * 4);
    memcpy(B_FAFFT, B, VEC_N_SIZE_32 * 4);
    bmul2_4096_to_4096((uint8_t *)r, (uint8_t *)A_FAFFT, (uint8_t *)B_FAFFT);
    radix16_81(rx, A, B);
    poly_xor(tmp, rx, r, LOW_LEN);
    radix16_81(t, tmp, p_inv);
    bit_shift_xor_81_asm(r, t, p_index_div32_sorted, p_index_mod32_cnt);
    reduce(res, r);
}
