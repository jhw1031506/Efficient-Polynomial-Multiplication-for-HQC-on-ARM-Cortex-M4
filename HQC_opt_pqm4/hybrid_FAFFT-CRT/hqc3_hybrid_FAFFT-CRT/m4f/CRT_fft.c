#include <string.h>
#include "gfmul_fft.h"
#include "parameters.h"
#include "radix16.h"
#include "reduce.h"
#include "CRT_fft.h"

#define N_FAFFT 65536
#define N_FAFFT_32 2048

#define LOW_LEN 193
#define SPARSE_HW 473

const uint32_t p_inv[LOW_LEN] = {
    0x96367d79, 0x9f0b5237, 0x2d58131b, 0x04a14aa0, 0x520ec9f7, 0xbf83579b, 0xf5010eb7, 0x6deb2d38,
    0xba69ee79, 0x326d109d, 0x5612c820, 0xab0c0c60, 0x7d054c2e, 0x01bed5bf, 0x4b84d4ab, 0x59dc8f47,
    0x2cf16322, 0x4dcde998, 0x900c6d29, 0xb18f51aa, 0xed0831a0, 0x28007dca, 0x2e2703ca, 0x6a0a24a7,
    0xb4827689, 0x80211979, 0xba05e8be, 0x01e28899, 0x93083611, 0xd4635235, 0xc92a25de, 0x741e729b,
    0x3b575b02, 0xde40e803, 0xa32ea54c, 0x622fdff4, 0x2e982eb8, 0x11367940, 0x3fbc63e6, 0xa93a4321,
    0x9e49997d, 0x19297723, 0x20f03dd3, 0x50c808b5, 0x0fe41de8, 0xc4308433, 0x7622ec29, 0x6479907d,
    0x870e8636, 0x4dae4ca6, 0x93069222, 0x1dd1470f, 0xaaba577b, 0x980c3b16, 0x8b7f062a, 0x8bf1b25a,
    0xde8a6e95, 0x1c9fcb92, 0xb0cb0ca1, 0x197b8e53, 0xa04c7c85, 0xe560038a, 0xfca65f53, 0x60935103,
    0xfe6f274c, 0x58d721e4, 0xfd7ffade, 0x0138ef0e, 0x68244b22, 0xdce63386, 0x5fb377a2, 0x85ea6f40,
    0xb30d3a31, 0xc6def3d7, 0x90d41aec, 0x8df6237f, 0x0c95287f, 0x6129f119, 0x353392d6, 0x1349ade9,
    0x5aeaa23e, 0x6c53d273, 0x386843f1, 0xb39fdb59, 0x32737941, 0x310bbaf8, 0x41f9466f, 0xb48eee62,
    0x03a3dcc0, 0x234d8ec6, 0x7ac2e5fc, 0x48c0c8b4, 0xb2210ee0, 0x99f8371b, 0x6c48d56b, 0xb32db08e,
    0xd639a1db, 0x2239f70e, 0xe39d1a1d, 0x97ccd9f9, 0x60c0b57e, 0x41606be3, 0xa778abd0, 0x2b2c0814,
    0x5ec76beb, 0x1cb590a1, 0x2e76b8e6, 0x70952c0a, 0x43af8bcc, 0xd16a06ba, 0x26550cc7, 0x8c569915,
    0x0bbff579, 0xdea20f12, 0xc11f156b, 0xf5ef98e9, 0x0c487872, 0xf7d13c8a, 0xb758130e, 0x647341eb,
    0x83eed9dc, 0x5be743ef, 0x8fd4d21e, 0x857fdc28, 0x6803939d, 0x694a4d1a, 0xca847a94, 0x7c423686,
    0x536477ef, 0xcf8b6766, 0x3824b10a, 0xa0458acf, 0x0a7c8fb7, 0x3d41f85d, 0x151a8aaa, 0x2b832ba9,
    0x01799fc4, 0xcacea320, 0x30feab9d, 0x07502071, 0x9a37f7be, 0x178b0d75, 0x57a2b811, 0x5314244f,
    0xa5ffae95, 0x52bf52db, 0x60c5ddd0, 0x66840bc0, 0xe18466c7, 0x9970cc19, 0x1ed55333, 0xe7d57b52,
    0xaf08fb8c, 0x8e4ddf18, 0x9b58ecee, 0xa077f138, 0x6236e23d, 0xf3194d80, 0x89748bc1, 0x7e052dab,
    0x081e7753, 0x24f39825, 0x852e0284, 0x729c9b30, 0x1569e472, 0xa3543dbb, 0x4793d641, 0x05a03840,
    0xed096e1f, 0x4cd97757, 0x907a2438, 0xeb596ee4, 0xdb3ff59d, 0x6e072501, 0xc3d7a75e, 0xe7243f1e,
    0xf82b4ed5, 0x7a2ff4b2, 0xb7389189, 0xb67268b7, 0x8f9f16c2, 0x685df46c, 0x1bf9e5d2, 0x86bbd073,
    0xfd963e9a, 0x0442b0d9, 0x770ce233, 0x716f8432, 0x6d2a4db7, 0x2fc08618, 0xd7ebc8a8, 0xadc43c1a,
    0x588b3e09};

const uint32_t p_index_div32_sorted[SPARSE_HW] = {
    0, 2, 5, 6, 8, 9, 10, 12, 13, 14, 15, 20, 
    24, 28, 30, 32, 36, 40, 44, 45, 60, 65, 66, 72, 
    73, 74, 75, 80, 88, 90, 96, 104, 105, 120, 128, 129, 
    130, 132, 133, 134, 135, 144, 148, 150, 160, 164, 165, 180, 
    192, 193, 194, 195, 208, 210, 224, 225, 240, 260, 264, 268, 
    270, 300, 320, 328, 330, 360, 384, 388, 390, 420, 448, 450, 
    480, 512, 516, 520, 524, 525, 540, 576, 584, 585, 600, 640, 
    644, 645, 660, 704, 705, 720, 780, 840, 900, 960, 1025, 1026, 
    1032, 1033, 1034, 1035, 1040, 1048, 1050, 1056, 1064, 1065, 1080, 1152, 
    1153, 1154, 1155, 1168, 1170, 1184, 1185, 1200, 1280, 1288, 1290, 1320, 
    1408, 1410, 1440, 1536, 1544, 1545, 1560, 1664, 1665, 1680, 1800, 1920, 
    2048, 1, 2, 4, 5, 6, 7, 16, 20, 22, 32, 36, 
    37, 52, 64, 65, 66, 67, 80, 82, 96, 97, 112, 256, 
    260, 262, 292, 320, 322, 352, 512, 516, 517, 532, 576, 577, 
    592, 772, 832, 1024, 1025, 1026, 1027, 1040, 1042, 1056, 1057, 1072, 
    1280, 1282, 1312, 1536, 1537, 1552, 1792, 4, 8, 12, 14, 44, 
    64, 72, 74, 104, 128, 132, 134, 164, 192, 194, 224, 524, 
    584, 644, 704, 1024, 1032, 1034, 1064, 1152, 1154, 1184, 1544, 1664, 
    0, 4, 6, 36, 64, 66, 96, 516, 576, 1024, 1026, 1056, 
    1536, 0, 4, 8, 12, 13, 28, 64, 72, 73, 88, 128, 
    132, 133, 148, 192, 193, 208, 268, 328, 388, 448, 1024, 1032, 
    1033, 1048, 1152, 1153, 1168, 1288, 1408, 0, 4, 5, 20, 64, 
    65, 80, 260, 320, 1024, 1025, 1040, 1280, 12, 72, 132, 192, 
    1032, 1152, 4, 64, 1024, 1, 2, 8, 9, 10, 11, 16, 
    24, 26, 32, 40, 41, 56, 128, 129, 130, 131, 144, 146, 
    160, 161, 176, 256, 264, 266, 296, 384, 386, 416, 512, 520, 
    521, 536, 640, 641, 656, 776, 896, 0, 1, 2, 3, 16, 
    18, 32, 33, 48, 256, 258, 288, 512, 513, 528, 768, 0, 
    8, 10, 40, 128, 130, 160, 520, 640, 0, 2, 32, 512, 
    0, 8, 9, 24, 128, 129, 144, 264, 384, 0, 1, 16, 
    256, 8, 128, 0, 0, 1, 2, 4, 5, 6, 7, 16, 
    20, 22, 32, 36, 37, 52, 64, 65, 66, 67, 80, 82, 
    96, 97, 112, 256, 260, 262, 292, 320, 322, 352, 512, 516, 
    517, 532, 576, 577, 592, 772, 832, 1024, 1025, 1026, 1027, 1040, 
    1042, 1056, 1057, 1072, 1280, 1282, 1312, 1536, 1537, 1552, 1792, 0, 
    4, 6, 36, 64, 66, 96, 516, 576, 1024, 1026, 1056, 1536, 
    0, 4, 5, 20, 64, 65, 80, 260, 320, 1024, 1025, 1040, 
    1280, 4, 64, 1024, 0, 1, 2, 3, 16, 18, 32, 33, 
    48, 256, 258, 288, 512, 513, 528, 768, 0, 2, 32, 512, 
    0, 1, 16, 256, 0
};

const uint32_t p_index_mod32_cnt[32] = {133, 54, 29, 13, 30, 13, 6, 3, 38, 16, 9, 4, 9, 4, 2, 1, 55, 0, 13, 0, 13, 0, 3, 0, 16, 0, 4, 0, 4, 0, 1, 0};

static void poly_xor(uint32_t *res, uint32_t *A, uint32_t *B, uint32_t len){
	for(uint32_t i=0; i<len; ++i){
		res[i] = A[i] ^ B[i];
	}
} 

void CRT_fft_HQC3(uint32_t *res, const uint32_t *A, const uint32_t *B){
    uint32_t A_FAFFT[N_FAFFT_32] = {0}, B_FAFFT[N_FAFFT_32] = {0};
    uint32_t rx[LOW_LEN << 1];
    uint32_t tmp[LOW_LEN];
    uint32_t t[LOW_LEN << 1];
    uint32_t r[2 * VEC_N_SIZE_32] = {0};
    memcpy(A_FAFFT, A, VEC_N_SIZE_32 * 4);
    memcpy(B_FAFFT, B, VEC_N_SIZE_32 * 4);
    bmul2_8192_to_8192((uint8_t *)r, (uint8_t *)A_FAFFT, (uint8_t *)B_FAFFT);
    radix16_193(rx, A, B);
    poly_xor(tmp, rx, r, LOW_LEN);
    radix16_193(t, tmp, p_inv);
    bit_shift_xor_193_asm(r, t, p_index_div32_sorted, p_index_mod32_cnt);
    reduce(res, r);
}